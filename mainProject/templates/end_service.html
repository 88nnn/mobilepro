<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이용 종료</title>
</head>
<body>
    <div class="container center">
        <div class="summary" id="summary"></div>
        <button class="btn_red" onclick="endService()">서비스 종료</button>
    </div>
    <div>
        <button class="start-service-btn" onclick="confirmStartService()">이용 시작</button>
    </div>

    <script>
        let startTime = null;
        let endTime = null;

        // 서버에서 user_id를 가져오는 함수
        async function fetchUserId() {
        const response = await fetch('/api/get_user_id');
        const data = await response.json();
        return data.user_id;
        }

        function displaySummary(userId, productId) {
            const summaryDiv = document.getElementById("summary");
            summaryDiv.innerHTML = `선택된 상품: ${Product.name}<br>사용자 ID: ${userId}`;
        }


        async function confirmStartService() {
            const userId = await fetchUserId();
            if (confirm("구매 정보가 저장되었습니다!")) {
                // 시작 시간 기록
                startTime = new Date().getTime(); // 밀리초 단위 타임스탬프
                // 구매 데이터를 서버로 전송
                selectedProducts.forEach(product => {
                    fetch('http://127.0.0.1:5000/api/save_purchase', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            product_id: product.product_id,
                            timestamp: startTime  // 시작 타임스탬프 저장
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                         console.log(data.message || data.error);
                    })
                    .catch(error => {
                        console.error('오류가 발생했습니다:', error);
                    });
                });
            }
        }

        async function confirmEndService() {
        const userId = await fetchUserId();
        if (confirm("정말로 이용을 종료하시겠습니까? \n세차를 완전히 마치셨다면 '예'를 선택해 주세요.")) {
            endTime = new Date().getTime(); // 종료 시간 기록
            const timeDelta = (endTime - startTime) / 1000; // 초 단위로 시간 계산

            // 구매 데이터를 서버로 전송 (duration_seconds 추가)
            selectedProducts.forEach(product => {
                fetch('http://127.0.0.1:5000/api/save_purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        product_id: product.product_id,
                        timestamp: startTime, // 시작 타임스탬프
                        duration_seconds: timeDelta // 총 이용 시간 (초 단위)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message || data.error);
                })
                .catch(error => {
                    console.error('오류가 발생했습니다:', error);
                });
            });

            // 다음 페이지로 이동
            window.location.href = 'usage_summary.html';
        }
    }
</script>